<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <title>Sign in with Plex - Scruffy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'scruffy-dark': '#1a1a2e',
                        'scruffy-darker': '#16162a',
                        'scruffy-accent': '#824334',
                        'scruffy-teal': '#304D54',
                        'scruffy-gray': '#C1C7CC',
                        'plex-orange': '#e5a00d',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Plex spinner for waiting state */
        .plex-spinner {
            border: 3px solid rgba(229, 160, 13, 0.3);
            border-top-color: #e5a00d;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scruffy Loading Overlay (same as base.html) */
        .scruffy-loading {
            position: fixed;
            inset: 0;
            background: #16162a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .scruffy-loading .mop {
            animation: mop-sweep 1.5s ease-in-out infinite;
        }
        @keyframes mop-sweep {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(15deg); }
        }
        .scruffy-loading .dots::after {
            content: '';
            animation: loading-dots 1.5s steps(4, end) infinite;
        }
        @keyframes loading-dots {
            0% { content: ''; }
            25% { content: '.'; }
            50% { content: '..'; }
            75% { content: '...'; }
        }
        .scruffy-loading .sparkle {
            position: absolute;
            animation: sparkle 2s ease-in-out infinite;
        }
        .scruffy-loading .sparkle:nth-child(1) { animation-delay: 0s; top: 20%; left: 30%; }
        .scruffy-loading .sparkle:nth-child(2) { animation-delay: 0.5s; top: 60%; left: 70%; }
        .scruffy-loading .sparkle:nth-child(3) { animation-delay: 1s; top: 40%; left: 20%; }
        .scruffy-loading .sparkle:nth-child(4) { animation-delay: 1.5s; top: 70%; left: 50%; }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="h-full bg-scruffy-darker">
    <!-- Full-screen loading overlay (hidden until auth success) -->
    <div id="scruffy-loading" class="scruffy-loading hidden">
        <div class="relative">
            <div class="sparkle">
                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2l1.5 5.5L17 9l-5.5 1.5L10 16l-1.5-5.5L3 9l5.5-1.5L10 2z"/>
                </svg>
            </div>
            <div class="sparkle">
                <svg class="w-3 h-3 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2l1.5 5.5L17 9l-5.5 1.5L10 16l-1.5-5.5L3 9l5.5-1.5L10 2z"/>
                </svg>
            </div>
            <div class="sparkle">
                <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2l1.5 5.5L17 9l-5.5 1.5L10 16l-1.5-5.5L3 9l5.5-1.5L10 2z"/>
                </svg>
            </div>
            <div class="sparkle">
                <svg class="w-4 h-4 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2l1.5 5.5L17 9l-5.5 1.5L10 16l-1.5-5.5L3 9l5.5-1.5L10 2z"/>
                </svg>
            </div>
            <div class="mop">
                <svg class="w-24 h-24" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="30" y="4" width="4" height="36" rx="2" fill="#8B7355"/>
                    <rect x="29" y="4" width="6" height="4" rx="1" fill="#A0522D"/>
                    <rect x="22" y="38" width="20" height="6" rx="2" fill="#696969"/>
                    <rect x="24" y="42" width="16" height="3" rx="1" fill="#505050"/>
                    <path d="M24 45 L22 60 Q22 62 24 62 L26 62 Q28 62 27 60 L26 45" fill="#C1C7CC"/>
                    <path d="M28 45 L27 60 Q27 62 29 62 L31 62 Q33 62 32 60 L30 45" fill="#D3D3D3"/>
                    <path d="M32 45 L32 60 Q32 62 34 62 L36 62 Q38 62 37 60 L34 45" fill="#C1C7CC"/>
                    <path d="M36 45 L37 60 Q37 62 39 62 L41 62 Q43 62 42 60 L40 45" fill="#D3D3D3"/>
                    <circle cx="20" cy="56" r="2" fill="#87CEEB" opacity="0.7"/>
                    <circle cx="44" cy="52" r="1.5" fill="#87CEEB" opacity="0.6"/>
                </svg>
            </div>
        </div>
        <p class="mt-6 text-lg text-gray-300">
            <span>Scruffy's cleaning up the data</span><span class="dots"></span>
        </p>
        <p class="mt-2 text-sm text-gray-500 italic">
            "Scruffy's gonna die the way he lived."
        </p>
    </div>

    <!-- Login content -->
    <div id="login-content" class="flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
            <img class="mx-auto h-24 w-auto" src="/static/scruffy.png" alt="Scruffy">
            <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-white">Scruffy</h2>
            <p class="mt-2 text-center text-sm text-gray-400">the Janitor</p>
        </div>

        <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
            <div class="bg-scruffy-dark py-8 px-4 shadow-xl sm:rounded-lg sm:px-10 border border-gray-700">
                <!-- Sign in state -->
                <div id="signin-state" class="space-y-6">
                    <p class="text-center text-gray-300 mb-6">
                        Sign in with your Plex account to view media requests and deletion schedules.
                    </p>
                    <a href="{{ auth_url }}" 
                       target="_blank"
                       onclick="startPolling()"
                       class="flex w-full justify-center items-center rounded-md bg-plex-orange px-4 py-3 text-sm font-semibold text-black shadow-sm hover:bg-yellow-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-plex-orange transition-colors">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Sign in with Plex
                    </a>
                </div>

                <!-- Waiting state -->
                <div id="waiting-state" class="space-y-6 hidden">
                    <div class="text-center">
                        <div class="flex justify-center mb-4">
                            <div class="plex-spinner"></div>
                        </div>
                        <p class="text-gray-300 mb-2">Waiting for Plex authentication...</p>
                        <p class="text-sm text-gray-500">Complete the sign-in in the Plex window that opened.</p>
                    </div>
                    <div class="text-center">
                        <button onclick="cancelPolling()" class="text-sm text-gray-400 hover:text-white transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Error state -->
                <div id="error-state" class="space-y-6 hidden">
                    <div class="text-center">
                        <div class="flex justify-center mb-4">
                            <svg class="w-12 h-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <p class="text-gray-300 mb-2" id="error-message">Authentication failed</p>
                        <button onclick="location.reload()" class="mt-4 text-plex-orange hover:text-yellow-500 transition-colors">
                            Try again
                        </button>
                    </div>
                </div>
            </div>

            <p class="mt-6 text-center text-xs text-gray-500">
                <em>"I've never seen him so proud."</em>
            </p>
        </div>
    </div>

    <script>
        const PIN_ID = {{ pin_id }};
        let pollInterval = null;
        let pollCount = 0;
        const MAX_POLLS = 120;

        function showState(state) {
            ['signin', 'waiting', 'error'].forEach(s => {
                document.getElementById(s + '-state').classList.toggle('hidden', s !== state);
            });
        }

        function showLoading() {
            document.getElementById('login-content').classList.add('hidden');
            document.getElementById('scruffy-loading').classList.remove('hidden');
        }

        function startPolling() {
            showState('waiting');
            pollCount = 0;
            
            const checkPin = async () => {
                pollCount++;
                
                if (pollCount > MAX_POLLS) {
                    showState('error');
                    document.getElementById('error-message').textContent = 'Authentication timed out. Please try again.';
                    return;
                }

                try {
                    const response = await fetch(`/auth/check-pin?pin_id=${PIN_ID}`, { method: 'POST' });
                    const data = await response.json();

                    if (data.authenticated) {
                        // Set session cookie
                        const secure = location.protocol === 'https:' ? '; secure' : '';
                        document.cookie = `${data.cookie_name}=${data.session_token}; max-age=${data.max_age}; path=/${secure}; samesite=lax`;
                        
                        // Show loading and redirect
                        showLoading();
                        window.location.href = '/';
                        return;
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
                
                pollInterval = setTimeout(checkPin, 1000);
            };
            
            pollInterval = setTimeout(checkPin, 1000);
        }

        function cancelPolling() {
            if (pollInterval) {
                clearTimeout(pollInterval);
                pollInterval = null;
            }
            showState('signin');
        }

        // Check for error from redirect
        const urlError = new URLSearchParams(location.search).get('error');
        if (urlError === 'not_claimed') {
            showState('error');
            document.getElementById('error-message').textContent = 'Please complete the Plex sign-in first.';
        } else if (urlError === 'not_imported') {
            showState('error');
            document.getElementById('error-message').textContent = 'Your Plex account is not imported on this server. Ask an admin to import users from Plex in Overseerr.';
        }
    </script>
</body>
</html>
